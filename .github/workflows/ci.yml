name: CI

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global init.defaultBranch main
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git bash
        
    - name: Verify Git version
      run: |
        git --version
        # cross_fixed.sh requires git 2.20+
        git_version=$(git --version | grep -o '[0-9]\+\.[0-9]\+' | head -1)
        major=$(echo $git_version | cut -d. -f1)
        minor=$(echo $git_version | cut -d. -f2)
        if [[ $major -lt 2 || ($major -eq 2 && $minor -lt 20) ]]; then
          echo "Git version $git_version does not meet minimum requirement (2.20)"
          exit 1
        fi
        echo "Git version $git_version meets requirements"
        
    - name: Make scripts executable
      run: |
        chmod +x cross_fixed.sh
        chmod +x tests/test_cross.sh
        
    - name: Syntax check cross_fixed.sh
      run: |
        # Test that the script can be parsed without errors
        bash -n cross_fixed.sh
        echo "✓ cross_fixed.sh syntax check passed"
        
    - name: Run comprehensive test suite
      run: |
        cd tests
        echo "Running comprehensive test suite..."
        ./test_cross.sh
        
    - name: Test cross_fixed.sh functions
      run: |
        echo "Testing cross_fixed.sh basic functionality..."
        
        # Initialize a test repository
        mkdir -p /tmp/ci_test
        cd /tmp/ci_test
        git init
        git config user.name "CI Test"
        git config user.email "ci@test.com"
        
        # Test basic functions
        echo "Testing setup function..."
        ${GITHUB_WORKSPACE}/cross_fixed.sh setup
        
        echo "✓ All cross_fixed.sh tests passed"
        
    - name: Check for common issues
      run: |
        echo "Checking for common issues..."
        
        # Check for bashisms if running on different shells
        if command -v checkbashisms >/dev/null 2>&1; then
          checkbashisms cross_fixed.sh || echo "Note: checkbashisms not available or found issues"
        fi
        
        # Check for proper shebang
        if head -1 cross_fixed.sh | grep -q "#!/bin/bash"; then
          echo "✓ Proper shebang found"
        else
          echo "⚠ Warning: Expected #!/bin/bash shebang"
        fi
        
        echo "✓ All checks completed"