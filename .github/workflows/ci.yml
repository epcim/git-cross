name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fish rsync jq
        # Install yq
        sudo wget --retry-connrefused --waitretry=1 --read-timeout=20 --timeout=15 -t 5 https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
        sudo chmod +x /usr/bin/yq
        # Install just
        curl --proto '=https' --tlsv1.2 -sSf --retry 5 --retry-connrefused --retry-delay 5 https://just.systems/install.sh | bash -s -- --to ~/bin
        echo "$HOME/bin" >> $GITHUB_PATH
        
    - name: Verify installation
      run: |
        just --version
        fish --version
        git --version
        rsync --version
        jq --version
        yq --version
        
    - name: Run dependency check
      run: just cross check-deps
      
    - name: Run all tests
      run: just cross-test
        
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: test/*.log
        retention-days: 7
        if-no-files-found: ignore
