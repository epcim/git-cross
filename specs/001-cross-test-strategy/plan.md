# Implementation Plan: cross command test strategy

**Branch**: `001-cross-test-strategy` | **Date**: 2025-12-01 | **Spec**: [`spec.md`](./spec.md)
**Input**: Feature specification from `/specs/001-cross-test-strategy/spec.md`
**Status**: In Progress / Partially Implemented

**Note**: This plan implements the governance-mandated workflow for `/speckit.plan`.
**Implementation Note**: The core logic is now implemented in `Justfile`, with `cross` script acting as a wrapper. Tests are Bash scripts invoking `just` commands.

## Summary

Build a repeatable automated test strategy for the `cross` CLI that:

- Runs the README "default testcase" end to end in both Bash and Rust harnesses while preventing the known `deploy/setup/flux` regression.
- Exercises `use` and `patch` flows against controlled git fixtures, validating sparse checkout sequencing and worktree hygiene.
- Aggregates constitution verification commands into a single entrypoint so contributors and CI obtain the full confidence bundle.

## Technical Context

**Implementation**: Justfile + Fish shell (December 2025 migration complete)  
**Language/Version**: Fish 3.x for complex logic, Bash for test harness  
**Primary Dependencies**: `git` ≥2.20, `just` (command runner), `fish` shell, `rsync`  
**Testing**: Bash test scripts in `test/bash/examples/` exercising Crossfile-001 through 005  
**Target Platform**: macOS and Linux with Homebrew support  
**Project Type**: Single CLI tool with `cross` wrapper script and vendorable `Justfile`  
**Performance Goals**: Full test suite <5 min; individual patches <60s  
**Constraints**: Must be vendorable into user repos, support `cross` command prefix, allow post-hooks via `exec`  
**Scale/Scope**: Cover all example Crossfiles plus core use/patch/sync/exec workflows

## Constitution Check

- **Upstream-First Patching**: Fixtures will use the same alias metadata and `_git` wrapper invocation path as production code. The plan keeps alias configuration under `.git/cross/` and verifies outputs without bypassing `_git`.
- **Worktree Hygiene**: Every test run begins by asserting both root and patch worktrees are clean. Harness scripts rerun `./cross status --refresh` and fail fast if dirtiness is detected. Temporary workspaces are destroyed on exit.
- **Portable Bash Discipline**: All new shell scripts will use Bash ≥4 syntax, four-space indentation, lower_snake_case functions, grouped constants/exports, and no new external dependencies beyond existing coreutils.
- **Transparent Automation**: Test prompts reuse `ask`, logging goes through `say`, and any new environment knobs (e.g., `CROSS_TEST_TMPDIR`) will be documented in README, spec, and plan. CI entrypoints remain non-interactive via `CROSS_NON_INTERACTIVE=1`.
- **Verification & Release Confidence**: The suite explicitly runs `bash -n cross`, `shellcheck cross`, and `./cross status --refresh`. Release preparation also copies `cross` to `cross_v<semver>.sh` when incrementing versions and ensures the executable bit is set.

## Project Structure

### Documentation (this feature)

```text
specs/001-cross-test-strategy/
├── plan.md          # This file
├── research.md      # Phase 0 findings
├── data-model.md    # Test entities and relationships
├── quickstart.md    # How to run the new suites
├── contracts/       # CLI interaction contracts (default/use/patch)
└── tasks.md         # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
cross                     # Existing CLI script
examples/                 # Reference Crossfiles exercised by tests

scripts/
└── fixture-tooling/      # Helpers to build local git fixtures (new)

test/
├── run-all.sh            # Aggregated entrypoint (calls bash + rust suites)
├── bash/
│   ├── default-test.sh   # README testcase (temp dir execution)
│   ├── use-alias.sh      # Alias registration checks
│   └── patch-workflow.sh # Sparse checkout & hygiene checks
├── rust/
│   ├── Cargo.toml        # Rust harness aligned with future rewrite
│   └── src/
│       └── default.rs    # Rust replica of default testcase
└── fixtures/
    ├── remotes/          # Local bare repos seeded for tests
    └── workspaces/       # Temporary directories (cleaned per run)
```

**Structure Decision**: Maintain single-project layout with a dedicated `test/` hierarchy that orchestrates both Bash and Rust harnesses. Time-limited temporary workspaces live under `test/fixtures/workspaces` during execution and are deleted afterward. Helper scripts under `scripts/fixture-tooling` own fixture setup logic to keep `cross` focused on CLI behaviour.

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|---------------------------------------|
| (none) | | |

## Phase 0 – Research

1. Identify a reliable strategy for creating local git remotes with sparse directories to mirror `bill:/setup/flux` and other examples without network access.  
2. Evaluate Bash vs. Bats vs. pure Rust harness for default testcase; confirm decision to keep Bash (fidelity to README) and add Rust parity tests for future rewrite.  
3. Determine best practice for configuring sparse checkout prior to `git fetch` within fixtures (likely leveraging `git config --worktree` and pre-populating `info/sparse-checkout`).  
4. Catalogue environment variables and knobs (`CROSS_NON_INTERACTIVE`, `CROSS_FETCH_DEPTH`, proposed `CROSS_TEST_TMPDIR`) and document defaults.

Deliverable: `research.md` containing decisions, rationale, and alternatives.

## Phase 1 – Design & Contracts

- Translate research outcomes into a concrete data model (`data-model.md`) covering fixtures, transcripts, verification bundles, and Rust/Bash harness relationships.  
- Author CLI interaction contracts under `contracts/` for:
  - README default testcase (both Bash and Rust expectations).
  - `use` alias registration flows, including idempotent reruns.
  - `patch` workflow with sparse checkout sequencing and `bill:/setup/flux` regression guard.  
- Produce `quickstart.md` documenting prerequisites (git ≥2.20, shellcheck, cargo), configuration steps, and `test/run-all.sh` usage.  
- Run `.specify/scripts/bash/update-agent-context.sh opencode` to ensure agent memory includes new tech (Rust crates, fixture tooling).  
- Re-check constitution gates: confirm plan still satisfies all five principles after design elaboration.

## Phase 2 – Preparation for Tasks

- Summarise implementation phases for `/speckit.tasks`, highlighting dependencies:
  1. Fixture scaffolding and temp workspace automation.
  2. Bash harness scripts for default, `use`, `patch`.
  3. Rust harness mirroring default testcase plus future extension hooks.
  4. Aggregated orchestration (`test/run-all.sh`) and verification bundle generation.
  5. Documentation updates (README verification section, quickstart).

## Risk Management & Mitigations

| Risk | Mitigation |
|------|------------|
| Fixture repos drift from real upstreams | Automate fixture seeding from locked commits and document update procedure in quickstart. |
| Sparse checkout sequencing regression | Add explicit assertions in `patch-workflow.sh` and contract documents verifying config-before-fetch. |
| Rust harness diverges from Bash behaviour | Compare artifact hashes/log outputs (SC-007) and gate CI on equivalence. |
| Temp directory cleanup failures | Implement trap handlers in Bash scripts and `tempfile::TempDir` in Rust to guarantee teardown. |

## Verification Strategy

1. `test/run-all.sh` orchestrates Bash scripts, Rust `cargo test`, `bash -n cross`, `shellcheck cross`, and `./cross status --refresh`.  
2. Output consolidated into `test/results/verification.json` summarising pass/fail per scenario, satisfying FR-004 and success criteria SC-003/SC-006/SC-009.  
3. CI integration ensures failure when any scenario emits non-zero status or mismatched directories.

## Deliverables Checklist

- [ ] `research.md` capturing fixture strategy, harness choices, sparse checkout sequencing.  
- [ ] `data-model.md` enumerating fixtures, transcripts, verification bundle entities.  
- [ ] `contracts/default-test.md`, `contracts/use.md`, `contracts/patch.md`.  
- [ ] `quickstart.md` with setup instructions and environment knobs.  
- [ ] Updated agent context via `.specify/scripts/bash/update-agent-context.sh opencode`.  
- [ ] Constitution gate revalidation notes appended to this plan after design.

## Constitution Revalidation (post-design)

All five principles remain satisfied: fixture tooling keeps upstream metadata intact (Principle I), hygiene checks guard worktrees (Principle II), shell scripts adhere to Bash discipline (Principle III), automation surfaces through `ask`/`say` and documented knobs (Principle IV), and verification commands plus release steps are embedded in the orchestration (Principle V).
